# Prep our working area
mkdir -p lib
mkdir -p tmp

# Build the runtime
nasm -f elf64 -o tmp/init.o src/init.asm
nasm -f elf64 -o tmp/syscall.o src/syscall.asm

# Build the standard library
gcc -x c -ffreestanding -nostdlib -nodefaultlibs -c -std=c99 src/core.h -o tmp/core.o -D CORE_H_HEADLIB -I ./src # "-x" force language
gcc -x c -ffreestanding -nostdlib -nodefaultlibs -c -std=c99 src/lib.h -o lib/lib.o -D CORE_H_HEADLIB -I ./src
gcc -x c -ffreestanding -nostdlib -nodefaultlibs -c -std=c99 src/rand.h -o lib/rand.o -D CORE_H_HEADLIB -I ./src
ld -z noexecstack -relocatable -o lib/core.o tmp/init.o tmp/syscall.o tmp/core.o

# Then size them up
echo "OBJECTS" && sizeof lib/*.o
echo "LIBRARY" && sizeof lib/*.h
cd ..

# Copy the headers into the lib folder
cp src/*.h lib/

# Cleanup
rm -rf tmp